# Roadmap проекта: сервис очистки ФИО (с подтверждением решений)

## Коротко о продукте
Мы делаем веб-приложение, которое помогает человеку принимать решения по проблемным ФИО:
- система делает безопасную нормализацию автоматически;
- находит проблемы, объясняет их и (если может) предлагает вариант исправления;
- пользователь подтверждает предложенный вариант или вводит свой;
- на основе решений пользователя формируются итоговые значения;
- сохраняется прозрачность: было → стало → почему.

Критерий "продукт готов": пользователь может подтвердить/ввести вариант в интерфейсе.

---

## Лестница шагов

### Шаг 1. Загрузка CSV и предпросмотр — ✅ завершён

Реализовано:
- загрузка CSV-файла через веб-интерфейс;
- сохранение файла на сервере (MEDIA_ROOT);
- предпросмотр столбцов и первых строк данных;
- выбор поля(ей) ФИО:
  - режим «одно поле» (ФИО целиком);
  - режим «отдельные поля» с возможностью выбрать 1–3 поля (Ф/И/О);
- сохранение выбора пользователя;
- прозрачные метрики по выбранным полям:
  - количество проверенных строк;
  - процент заполненности;
  - примеры значений;
- неблокирующие предупреждения для редких/пустых полей.

Статус: шаг полностью реализован и протестирован локально.

---

### Шаг 2. Автонормализация без риска — ✅ завершён (MVP: 2.1–2.3)

Цель шага: показать пользователю безопасную автонормализацию выбранных полей ФИО
**в режиме предпросмотра**, без угадывания и без изменения смысла данных.

Принципы:
- нормализация только формата, не смысла;
- все изменения прозрачны и обратимы;
- ничего не сохраняется как итоговое значение;
- одинаково работает для одного поля и для нескольких.

#### 2.1 Явная точка входа в UI (MVP)
После подтверждения выбранных полей (Шаг 1) на странице появляется отдельный блок
**«Шаг 2. Нормализация»** с кнопкой:

- «показать нормализацию» (preview)

По нажатию открывается отдельная страница/экран, где отображается контекст:
- название загруженного файла;
- базовая информация по файлу (например: количество строк);
- выбранные пользователем поля ФИО;
- допускается повтор краткой статистики из Шага 1.

На этом этапе допустима заглушка вместо таблицы нормализации —
цель инкремента: зафиксировать правильное место шага в интерфейсе.

Статус: реализовано — добавлен блок нормализации с кнопкой и отдельная страница предпросмотра с заглушкой.

#### 2.2 Безопасная нормализация значений + справочники (MVP)
Добавляется нормализация отдельных значений ФИО, применяемая независимо
к каждому выбранному полю.

Разрешённые действия:
- очистка пробелов;
- удаление мусорных/невидимых символов;
- нормализация тире;
- приведение регистра.

Запрещено:
- угадывание;
- исправление опечаток;
- транслитерация;
- склейка или перестановка частей ФИО.

Технические статусы:
- `ok`
- `fixed`
(в будущем: `needs_review`, `error`)

Пользовательские подписи (все строчными):
- `ok` → «ок»
- `fixed` → «нормализовано»
- `needs_review` → «требует проверки»

Все пользовательские тексты и статусы хранятся в словарях/константах,
чтобы их можно было менять без изменения бизнес-логики.

Статус: ✅ реализовано и протестировано (unit-тесты + Django shell + UI).

#### 2.3 Результаты нормализации (MVP)
На странице нормализации отображается:

1) Сводка по строкам:
   - сколько строк без изменений (`ок`);
   - сколько строк с нормализацией (`нормализовано`);
   - количество и доля.

2) Примеры:
   - выводится N строк, где была выполнена нормализация
     (если хотя бы в одном выбранном поле были изменения).

3) Если нормализованных строк нет:
   - сообщение «изменений не обнаружено»;
   - дополнительно показываются N строк примеров (например, верхние строки файла).

Примечание: на уровне MVP N фиксированный (например, 20).

Статус: ✅ реализовано и протестировано (unit-тесты + Django shell + UI).

---

### Отложенные улучшения Шага 2 (после MVP / не обязательно сразу)
- статистика по типам нормализаций (что исправлялось чаще всего);
- возможность выбрать количество строк или «показать ещё»;
- случайная выборка примеров при отсутствии изменений (с фиксированным seed);
- более детальная статистика по полям (не только по строкам, но и по ячейкам);
- улучшение визуального выделения изменений.

---

### Шаг 3. Флаги проблем + ранняя выгрузка — ✅ реализован (MVP)

Реализовано (MVP):

- введён статус `needs_review` для значений, требующих участия пользователя;
- реализован минимальный набор форматных и технических флагов:
  - наличие цифр;
  - недопустимые символы;
  - смешанный алфавит;
  - полностью латинское написание;
  - слишком короткое значение;
  - слишком много слов;
- флаги вычисляются на уровне ячейки (строка + поле);
- пустые значения не считаются ошибкой и не получают флагов;
- автоматические исправления на этом шаге не выполняются;
- пользователю показывается человекочитаемый комментарий на русском языке;
- коды флагов сохраняются во внутренних данных, но скрыты в UI;
- статистика расширена:
  - `ok`;
  - `fixed`;
  - `needs_review`;
  - доли по каждому статусу;
- реализован предпросмотр без сохранения решений пользователя;
- архитектура подготовлена для:
  - фильтрации по статусу и типу флага;
  - ручного принятия решений на следующем шаге.

Статус: шаг реализован и протестирован локально (unit-тесты + проверка в браузере).

Дополнительно (заложено концептуально):

- на этом шаге допускаются логические диагностические флаги
  (без автоматических исправлений), например:
  - возможное несоответствие имени и отчества;
  - подозрение на опечатку в имени или отчестве;
- такие флаги:
  - всегда имеют статус `needs_review`;
  - не применяются, если данные неполные или неоднозначные;
  - служат только сигналом для пользователя и/или для генерации предложений на следующем шаге.

### Шаг 3.5. Генерация предложений исправлений (MVP)

Уровень уверенности (confidence):
- используется текстовая шкала: `high`, `medium`;
- в пользовательском интерфейсе отображаются подписи:
  - `high` → «высокая»;
  - `medium` → «средняя»;
- предложения с уверенностью ниже `medium` не формируются.

Словарь имён:
- используется единый CSV-словарь, редактируемый человеком;
- формат словаря:

  `canonical, variant, enabled, note, source`

  где:
  - `canonical` — каноническая форма имени;
  - `variant` — вариант написания или опечатка (может быть пустым);
  - `enabled` — флаг активности записи (1/0);
  - `note` — комментарий (необязательно);
  - `source` — источник (`base`, `user`, `import`).

- словарь поддерживает:
  - канонические формы имён;
  - подтверждённые соответствия `raw → canonical`;
- ошибочные подтверждения могут быть отключены без удаления;
- в будущем планируется UI для редактирования словаря с разграничением прав.

Транслитерация и замена символов:
- если значение полностью на латинице:
  - используется официальная транслитерация с учётом диграфов и триграфов
    (`ya/ia → я`, `zh`, `ch`, `sh`, `shch` и т.п.);
  - предложение формируется только при полном успешном разборе;
  - `confidence = high`;
- если значение содержит смешение кириллицы/латиницы/цифр:
  - применяется замена визуальных двойников
    (`C↔С`, `O↔О`, `A↔А`, `E↔Е`, `0↔О` и т.п.);
  - предложение носит рекомендательный характер;
  - `confidence = medium`;
- все предложения требуют явного подтверждения пользователем.

Контроль значений без флагов:
- остаётся открытым вопрос контроля качества значений со статусом `ok`;
- рассматриваются варианты:
  - случайная контрольная выборка;
  - read-only просмотр без возможности редактирования;
- решение будет принято после первых реальных прогонов.

Цель шага: предложить пользователю возможные варианты исправления
проблемных значений ФИО **без автоматического применения изменений**.

Принципы:
- система ничего не исправляет сама;
- все предложения носят рекомендательный характер;
- каждое предложение сопровождается объяснением причины;
- пользователь всегда принимает итоговое решение.

В рамках MVP предлагаются следующие типы исправлений:

- транслитерация латиницы → кириллица
  (если значение полностью или частично на латинице);
- исправление опечаток по словарю имён
  (при высокой степени уверенности);
- в будущем — предложения по согласованию имени и отчества
  (на основе справочников и правил).

Технические положения:
- предложение может существовать даже без диагностического флага;
- диагностический флаг может существовать без предложения;
- каждое предложение имеет:
  - предлагаемое значение;
  - текстовое объяснение;
  - источник/тип правила;
  - уровень уверенности (внутренний).

Статус: запланировано, реализация после Шага 3.

### Шаг 4. Принятие решений пользователем
- принять предложение;
- оставить как есть;
- ввести свой вариант.

### Шаг 5. Финальная выгрузка
- итоговое поле на основе решений.

### Шаг 6. Улучшения
- групповые решения;
- фильтры;
- повторные прогоны;
- справочники.
